<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Chat - PeerJS</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            text-align: center;
        }
        .container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .peer-id-box {
            background: #f5f5f5;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            font-size: 18px;
            word-break: break-all;
        }
        input, button {
            padding: 10px 15px;
            font-size: 16px;
            margin: 5px;
            border-radius: 4px;
        }
        input {
            border: 1px solid #ddd;
            width: 200px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .connected { color: #28a745; }
        .disconnected { color: #dc3545; }
        audio { display: none; }
    </style>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Voice Chat</h1>
        
        <!-- Your Peer ID -->
        <div class="peer-id-box">
            <strong>Your Peer ID:</strong>
            <span id="my-peer-id">Click button to generate...</span>
            <button id="generate-btn" style="background:#28a745; font-size:14px; padding:5px 10px;">Generate ID</button>
        </div>

        <!-- Connection Status -->
        <div id="connection-status" class="status disconnected">Not Connected</div>

        <!-- Call Area -->
        <div>
            <input type="text" id="remote-peer-id" placeholder="Enter peer's ID">
            <button id="call-btn" disabled>Call</button>
            <button id="hangup-btn" disabled style="background:#dc3545;">Hang Up</button>
        </div>

        <!-- Incoming Call -->
        <div id="incoming-call" style="display:none; margin-top:20px;">
            <p><strong>Incoming Call!</strong></p>
            <button id="accept-call" style="background:#28a745;">Accept</button>
            <button id="reject-call" style="background:#6c757d;">Reject</button>
        </div>

        <audio id="remote-audio" autoplay></audio>
    </div>

    <script>
        // Elements
        const myPeerIdSpan = document.getElementById('my-peer-id');
        const remotePeerIdInput = document.getElementById('remote-peer-id');
        const callBtn = document.getElementById('call-btn');
        const hangupBtn = document.getElementById('hangup-btn');
        const connectionStatus = document.getElementById('connection-status');
        const incomingCallDiv = document.getElementById('incoming-call');
        const acceptCallBtn = document.getElementById('accept-call');
        const rejectCallBtn = document.getElementById('reject-call');
        const remoteAudio = document.getElementById('remote-audio');
        const generateBtn = document.getElementById('generate-btn');

        let peer = null;
        let localStream = null;
        let currentCall = null;
        let isCallActive = false;

        // Generate random Peer ID
        function generatePeerId() {
            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
            let id = 'voice-';
            for (let i = 0; i < 8; i++) {
                id += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return id;
        }

        // Initialize Peer
        function initPeer(customId = null) {
            myPeerIdSpan.textContent = 'Connecting...';
            
            const peerId = customId || generatePeerId();
            console.log('Initializing Peer, ID:', peerId);
            
            peer = new Peer(peerId, {
                debug: 2
            });

            peer.on('open', (id) => {
                console.log('Connected! My ID:', id);
                myPeerIdSpan.textContent = id;
                myPeerIdSpan.style.cursor = 'pointer';
                myPeerIdSpan.title = 'Click to copy';
                myPeerIdSpan.onclick = () => {
                    navigator.clipboard.writeText(id);
                    alert('Copied: ' + id);
                };
                updateStatus('connected', 'Connected! Share your ID with friends.');
                callBtn.disabled = false;
            });

            peer.on('error', (err) => {
                console.error('Error:', err);
                if (err.type === 'unavailable-id') {
                    console.log('ID taken, regenerating...');
                    initPeer(generatePeerId());
                } else if (err.type === 'peer-unavailable') {
                    alert('Peer ID does not exist');
                } else {
                    updateStatus('disconnected', 'Error: ' + err.type);
                }
            });

            peer.on('disconnected', () => {
                console.log('Disconnected, reconnecting...');
                updateStatus('disconnected', 'Disconnected, reconnecting...');
                if (peer && !peer.destroyed) {
                    peer.reconnect();
                }
            });

            peer.on('call', (call) => {
                console.log('Incoming call', call);
                
                if (!localStream) {
                    alert('Please allow microphone access first');
                    return;
                }

                incomingCallDiv.style.display = 'block';

                acceptCallBtn.onclick = () => {
                    incomingCallDiv.style.display = 'none';
                    call.answer(localStream);
                    handleCall(call);
                };

                rejectCallBtn.onclick = () => {
                    incomingCallDiv.style.display = 'none';
                    call.close();
                };
            });
        }

        // Get microphone access
        async function getMicrophoneAccess() {
            try {
                updateStatus('disconnected', 'Requesting microphone...');
                
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        noiseSuppression: true,
                        echoCancellation: true
                    },
                    video: false
                });
                
                console.log('Microphone access granted');
                updateStatus('connected', 'Microphone ready! Click Generate ID.');
                
            } catch (err) {
                console.error('Mic error:', err);
                updateStatus('disconnected', 'Cannot access microphone: ' + err.message);
                alert('Cannot access microphone. Please allow permission.');
            }
        }

        // Handle call
        function handleCall(call) {
            currentCall = call;
            isCallActive = true;
            
            callBtn.disabled = true;
            hangupBtn.disabled = false;
            remotePeerIdInput.disabled = true;
            updateStatus('connected', 'In call...');

            call.on('stream', (remoteStream) => {
                console.log('Received remote stream');
                remoteAudio.srcObject = remoteStream;
                remoteAudio.play().catch(e => {
                    console.log('Click to enable audio');
                });
            });

            call.on('close', () => {
                console.log('Call closed');
                cleanupCall();
            });

            call.on('error', (err) => {
                console.error('Call error:', err);
                cleanupCall();
            });
        }

        // Cleanup
        function cleanupCall() {
            if (remoteAudio.srcObject) {
                remoteAudio.srcObject.getTracks().forEach(track => track.stop());
                remoteAudio.srcObject = null;
            }
            
            isCallActive = false;
            currentCall = null;
            
            callBtn.disabled = false;
            hangupBtn.disabled = true;
            remotePeerIdInput.disabled = false;
            updateStatus('connected', 'Disconnected');
        }

        // Update status
        function updateStatus(state, message) {
            connectionStatus.textContent = message;
            connectionStatus.className = `status ${state}`;
        }

        // Event listeners
        generateBtn.addEventListener('click', async () => {
            if (!localStream) {
                await getMicrophoneAccess();
            }
            if (peer) {
                peer.destroy();
            }
            initPeer(generatePeerId());
        });

        callBtn.addEventListener('click', async () => {
            const remoteId = remotePeerIdInput.value.trim();
            if (!remoteId) {
                alert('Enter peer ID');
                return;
            }

            if (!localStream) {
                alert('Click Generate ID first');
                return;
            }

            if (!peer) {
                alert('Click Generate ID first');
                return;
            }

            try {
                const call = peer.call(remoteId, localStream);
                handleCall(call);
            } catch (err) {
                console.error('Call failed:', err);
                alert('Call failed');
            }
        });

        hangupBtn.addEventListener('click', () => {
            if (currentCall) {
                currentCall.close();
            }
            cleanupCall();
        });

        window.addEventListener('beforeunload', () => {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (peer) {
                peer.destroy();
            }
        });
    </script>
</body>
</html>
